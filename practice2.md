# Практика 2 — 3.1 Персистентность данных

## ТЗ

- Реализовать `geojson` базу данных с журналом записи транзакций и снапшотом состояния
- Добавить первичный индекс по полю `ID`
- Добавить вторичный `spatial` индекс по полю `Geometry`

## Архитектура

![Architecture](img/practice2-arch.png)

## ТЗ

Движком хранения и обработки данных является горутина:
- `Engine`

Горутина `Engine` отвечает за `in-memory` хранение данных:
- создание и сохранение транзакции в файл журнал
- меняет эти данные
- индексирует данные
- возвращает данные по запросу
- сохраняет данные в файл чекпоинт

Горутина `Engine` при запуске должна прочитать чекпоинт файл с данными затем должна прочитать файл с журналом транзакций.

Горутина должны завершаться в вызове `Stop` структуры `Storage`.
Для взаимодействия с горутиной использовать каналы.
Для управления горутиной использовать `context.Context`.

## Индексация

- Индексы неперсистентные и не больше, чем оперативная память
- Для индексов использовать готовые решения:
  - Первичный `map[string]any`
  - Spatial, например https://github.com/tidwall/rtree
- Проиндексировать feature с помощью rtree

## LSN

LSN — log sequence number. Локальный счетчик транзакций.
LSN + name — уникальный идентификатор транзакции.

## Транзакции

Транзакция сериализуется в структуру `Transaction`:
- `action :string`
  - значения
    - `insert`
    - `replace`
    - `delete`
- `name :string`
  - значение `name` в сервисе
- `lsn :uint64`
  - постоянно возрастающий локальный счетчик
- `feature :any`
  - значения из стандарта `https://geojson.org`

## Checkpoint

Горутина `Engine` должна обеспечить консистентное сохранения данных в файл чекпоинт.
Файл чекпоинт должен представлять из себя как бы журнал `insert` транзакций.
После `checkpoint` процедуру журнал транзакций можно очистить.

## `GET /select`

- Модифицировать метод `/select` так, чтобы с помощью rtree индекса выбирать только нужные данные.
- Метод /select принимает GET параметр `rect`
- Парсинг параметра `rect`
```
  get := r.URL.Query().Get("rect")
	rect := strings.Split(get, ",")
	if len(rect) < 4 {
		return
	}

	minx, err := strconv.ParseFloat(rect[0], 64)
	// check err
	miny, err := strconv.ParseFloat(rect[1], 64)
	// check err
	maxx, err := strconv.ParseFloat(rect[2], 64)
	// check err
	maxy, err := strconv.ParseFloat(rect[3], 64)
	// check err
	min := [2]float64{minx, miny}
	max := [2]float64{maxx, maxy}
```
- С помощью `min`, `max` получить у `rtree` индекса необходимые данные

## Добавить http api


- `POST /checkpoint`
  - запускает `checkpoint` продедуру в горутине `Engine`
